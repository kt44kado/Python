# マルチエージェントシステム プログラム仕様書

本ドキュメントは、StreamlitおよびAutoGenを用いたマルチエージェントシステムの仕様を記述したものです。

## 1. システム概要
ユーザーが入力したテーマやPDFファイルの内容に基づき、複数の専門エージェントが議論を行い、結論を導き出すシステムです。特にデータベース（Dr.Sum）との連携機能を持ち、在庫状況などのリアルタイムなデータ取得が可能です。

## 2. エージェント構成

### オーケストレーター (Manager)
- **役割:** 議論の進行管理、要約、発言者の指名。
- **システムメッセージ:** ユーザーの入力を要約し、最初に発言すべきエージェントを指名。議論終了時に提案をまとめる。

### 受注情報(VWSDT0100) (Specialist)
- **役割:** 受注情報に関する専門家。
- **対象データ:** `z00_情報系DB` の `VWSDT0100` ビュー。
- **制約:** 指定されたビュー以外へのアクセス禁止。カラム名不明時は `get_schema` を使用。

### 購買発注(VWMMT0100) (Specialist)
- **役割:** 購買発注に関する専門家。
- **対象データ:** `z00_情報系DB` の `VWMMT0100` ビュー。
- **制約:** 指定されたビュー以外へのアクセス禁止。カラム名不明時は `get_schema` を使用。

### 在庫状況照会 (Tool User)
- **役割:** 在庫状況の照会。Dr.Sumツールを使用可能。
- **対象データ:** `z00_情報系DB` の `V_在庫状況照会` ビュー。
- **使用可能ツール:** `execute_select`, `get_schema` 等。
- **制約:** 指定されたビュー以外へのアクセス禁止。推測での回答禁止。

### 品目マスタ(VWMMM0100) (Specialist)
- **役割:** 品目マスタに関する専門家。
- **対象データ:** `z00_情報系DB` の `VWMMM0100` ビュー。
- **制約:** 指定されたビュー以外へのアクセス禁止。カラム名不明時は `get_schema` を使用。

### User (Proxy)
- **役割:** ユーザープロキシ。ツールの実行を担当。
- **設定:** 自動返信最大10回。Docker不使用。

## 3. 使用可能ツール (Dr.Sum連携)
「在庫状況照会」エージェントが使用できるツール群です。

| ツール名 | 説明 |
| :--- | :--- |
| `get_database_list` | データベースの一覧を取得します。 |
| `get_table_list` | 指定されたデータベース内のテーブル/ビュー一覧を取得します。 |
| `get_schema` | 指定されたテーブル/ビューのカラム定義（スキーマ）を取得します。 |
| `execute_select` | SELECT文を実行してデータを取得します。 |
| `measure_select` | SELECT文を複数回実行し、実行時間の統計を取得します。 |
| `get_view_definition` | ビューのSQL定義を取得します。 |
| `get_sql_specification` | Dr.SumのSQL仕様を取得します。 |

## 4. アプリケーションフロー (UI)

### 画面構成と処理フロー
1. **初期設定:** 環境変数読み込み、Azure OpenAI設定。
2. **サイドバー/メインエリア:**
    - エージェント選択 (マルチセレクト)
    - テーマ入力 (テキスト入力)
    - 参照ファイルパス入力 (PDF読み込み用)
3. **インプット処理:**
    - 「エージェントへインプット」ボタン押下。
    - PDFがある場合はテキスト抽出。
    - ユーザーメッセージを作成 (PDF内容 + テーマ)。
    - GroupChatおよびManagerの初期化。
    - `initiate_chat` で会話開始。
4. **議論開始:**
    - 「ディスカッションを開始します」ボタン押下。
    - チャット履歴の表示 (エージェントごとに色分け・アイコン表示)。
5. **フォローアップ:**
    - 追加質問入力フォーム。
    - 送信時、履歴を保持したまま (`clear_history=False`) 会話を再開。

## 5. ファイル構成
- `app.py`: Streamlitアプリケーション本体。UIとメインロジック。
- `agents.py`: エージェント定義、システムメッセージ生成、ツール登録。
- `drsum_tools.py`: Dr.Sum MCPサーバーとの連携ツール定義。
